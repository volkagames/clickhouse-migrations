# ============================================================================
# Release Workflow
# ============================================================================
# This workflow automates the release process for the ClickHouse Migrations package.
#
# Workflow Overview:
# 1. Release Please creates/updates a release PR when changes are pushed to main
# 2. When the release PR is merged, it creates a GitHub release and git tag
# 3. The package is then built, tested, and published to npm
#
# Triggers:
# - Runs on every push to the main branch
# - Release Please analyzes commit messages using Conventional Commits
# - Creates/updates a release PR with changelog and version bump
#
# Jobs:
# - release-please: Manages release PR creation and GitHub releases
# - publish: Builds, tests, and publishes the package to npm (only on release)
#
# Authentication:
# - Release Please: Uses RELEASE_PLEASE_TOKEN secret (required for org repos)
# - npm Publishing: Uses OIDC Trusted Publisher for secure, automated publishing
#   No npm secrets required - GitHub issues short-lived tokens automatically
#
# Setup Instructions:
#
# 1. Create GitHub Personal Access Token (for Release Please):
#    a. Go to https://github.com/settings/tokens?type=beta
#    b. Click "Generate new token" (fine-grained token)
#    c. Configure token:
#       - Token name: "Release Please - volkagames/clickhouse-migrations"
#       - Expiration: 1 year (or your preference)
#       - Resource owner: volkagames
#       - Repository access: Only select repositories â†’ clickhouse-migrations
#       - Permissions:
#         * Contents: Read and write
#         * Pull requests: Read and write
#         * Metadata: Read-only (automatically selected)
#    d. Generate token and copy it
#    e. Add to repository secrets:
#       - Go to https://github.com/volkagames/clickhouse-migrations/settings/secrets/actions
#       - Click "New repository secret"
#       - Name: RELEASE_PLEASE_TOKEN
#       - Value: paste the token
#
# 2. Configure npm Trusted Publisher (for npm publishing):
#    a. Go to https://www.npmjs.com/package/@volkagames/clickhouse-migrations/access
#    b. Scroll to "Publishing access" section
#    c. Click "Add trusted publisher"
#    d. Fill in:
#       - Provider: GitHub Actions
#       - Organization: volkagames
#       - Repository: clickhouse-migrations
#       - Workflow: release.yml
#       - Environment: (leave blank)
#
# Documentation:
# - Release Please: https://github.com/googleapis/release-please
# - Conventional Commits: https://www.conventionalcommits.org/
# - OIDC Publishing: https://docs.npmjs.com/generating-provenance-statements
# ============================================================================

name: Release

# Required permissions for OIDC authentication with npm
permissions:
  contents: write  # Needed for Release Please to create releases
  id-token: write  # Needed for OIDC authentication with npm
  pull-requests: write  # Needed for Release Please to create PRs

on:
  push:
    branches:
      - main

jobs:
  # ============================================================================
  # Release Please Job
  # ============================================================================
  # Manages the release process by analyzing commit messages and creating
  # release PRs with automatic version bumping and changelog generation.
  #
  # Outputs:
  # - release_created: Boolean indicating if a new release was created
  # - tag_name: The git tag for the release (e.g., "v2.0.0")
  # ============================================================================
  release-please:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Run Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          # Configuration for Node.js package releases
          release-type: node
          # Use custom token for organization repositories
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

  # ============================================================================
  # Publish Job
  # ============================================================================
  # Builds, tests, and publishes the package to npm registry.
  # Only runs when a new release is created by Release Please.
  #
  # Steps:
  # 1. Checkout the repository code
  # 2. Set up Bun (required by package.json engines)
  # 3. Install project dependencies
  # 4. Run linting and formatting checks
  # 5. Run all tests (unit, integration, e2e)
  # 6. Build the distributable package
  # 7. Publish to npm registry
  # ============================================================================
  publish:
    name: Build and Publish to npm
    runs-on: ubuntu-latest
    needs: release-please
    # Only run this job if a new release was created
    if: ${{ needs.release-please.outputs.release_created }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Required for npm OIDC trusted publishing
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.23

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Run Code Quality Checks
        run: bun run check

      - name: Run Tests
        run: bun run test:unit

      - name: Build Package
        run: bun run build

      - name: Publish to npm with OIDC
        run: npm publish --access public
