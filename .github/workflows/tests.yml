# ============================================================================
# Test Workflow
# ============================================================================
# This workflow runs comprehensive tests for the ClickHouse Migrations package
# across multiple Node.js versions and ClickHouse versions.
#
# Workflow Overview:
# 1. Code Quality: Runs linting and formatting checks
# 2. Unit Tests: Fast, isolated tests without external dependencies
# 3. Integration Tests: Tests against real ClickHouse instances (scheduled only)
# 4. E2E Tests: End-to-end CLI testing with migration verification
#
# Triggers:
# - Manual dispatch: Can be triggered manually from GitHub Actions UI
# - Pull requests: Runs code quality + unit tests (prevents bypassing Husky hooks)
# - Scheduled: Monthly full integration tests with ClickHouse (1st day of month)
#
# Test Strategy:
# - On PR: Code quality + unit tests (safety net against --no-verify)
# - Monthly scheduled: Full integration test matrix to catch compatibility issues
# - Manual trigger: Run full test suite on demand
#
# Note: Husky hooks already enforce tests locally (pre-commit and pre-push),
# so CI tests on main branch push are redundant. PR tests catch cases where
# developers might bypass hooks with --no-verify.
#
# Test Matrix:
# - Node.js versions: 20, 22, 24 (covering LTS and current releases)
# - ClickHouse versions: latest stable and head (development version)
#
# Jobs:
# - code-quality: Linting and formatting checks
# - unit-tests: Fast unit tests across Node.js versions
# - integration-tests: Tests against real ClickHouse instances (conditional)
#
# Documentation:
# - Vitest: https://vitest.dev/
# - ClickHouse: https://clickhouse.com/docs
# ============================================================================

name: Tests

on:
  # Allow manual workflow trigger with option to run integration tests
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: 'Run integration tests with ClickHouse'
        required: false
        type: boolean
        default: true

  # Run on pull requests (code quality + unit tests)
  # This catches cases where developers bypass Husky hooks with --no-verify
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'

  # Run full integration tests monthly (1st day of month at 9:00 AM UTC)
  schedule:
    # Monthly: 1st day of the month at 9:00 AM UTC
    - cron: '0 9 1 * *'

jobs:
  # ============================================================================
  # Code Quality Job
  # ============================================================================
  # Runs linting and formatting checks using Biome to ensure code quality
  # standards are met before running tests.
  # ============================================================================
  code-quality:
    name: Code Quality (Lint & Format)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Linting
        run: pnpm run lint

      - name: Run Code Quality Checks
        run: pnpm run check

  # ============================================================================
  # Unit Tests Job
  # ============================================================================
  # Runs fast, isolated unit tests across multiple Node.js versions.
  # These tests don't require external dependencies like databases.
  #
  # Matrix Strategy:
  # - Tests on Node.js 20 (LTS), 22 (LTS), and 24 (Current)
  # - Fails fast to save CI resources if a version fails
  # ============================================================================
  unit-tests:
    name: Unit Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      fail-fast: true
      matrix:
        node: [20, 22, 24]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Unit Tests
        run: pnpm run test:unit

  # ============================================================================
  # Integration Tests Job
  # ============================================================================
  # Runs integration and E2E tests against real ClickHouse instances.
  # Tests the CLI and migration functionality with actual databases.
  #
  # Conditional Execution:
  # - Only runs on manual dispatch or monthly scheduled runs
  # - Skipped on regular pushes to save CI resources
  #
  # Matrix Strategy:
  # - Node.js versions: 20, 22, 24
  # - ClickHouse versions:
  #   - latest: Current stable release
  #   - head: Development version (catches upcoming breaking changes)
  #
  # Test Steps:
  # 1. Start ClickHouse in Docker
  # 2. Build the CLI tool
  # 3. Run migration tests against the database
  # 4. Verify migrations were applied correctly
  # 5. Run TLS/SSL integration tests
  # ============================================================================
  integration-tests:
    name: Integration Tests (Node ${{ matrix.node }}, ClickHouse ${{ matrix.clickhouse }})
    runs-on: ubuntu-latest
    needs: unit-tests
    # Only run integration tests on:
    # - Scheduled runs (monthly)
    # - Manual dispatch when explicitly enabled (default: true)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_integration_tests)
    strategy:
      fail-fast: true
      matrix:
        node: [20, 22, 24]
        clickhouse: [latest, head]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Start ClickHouse ${{ matrix.clickhouse }} and wait for healthcheck
        env:
          CLICKHOUSE_VERSION: ${{ matrix.clickhouse }}
          DOCKER_NETWORK_MODE: host
          DOCKER_LOGGING_DRIVER: none
        run: |
          docker compose up -d --wait
          echo "✓ ClickHouse is ready (healthcheck passed)!"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Package
        run: pnpm run build

      - name: Apply Test Migrations
        run: |
          node ./dist/cli.js migrate \
            --host=http://localhost:8123 \
            --user=default \
            --password='' \
            --db=analytics \
            --migrations-home=./tests/migrations/few

      - name: Verify Migrations Applied
        run: |
          echo "Verifying that migration tables were created..."

          # Query ClickHouse for expected tables
          response=$(curl -s "http://localhost:8123/?query=SELECT%20groupArray(name)%20FROM%20system.tables%20WHERE%20name%20IN%20('_migrations','events','sessions')%20AND%20database%20=%20'analytics'")

          echo "Database response: $response"

          # Expected tables array from migrations
          expected_tables="['_migrations','events','sessions']"

          # Verify all tables were created
          if [ "$response" = "$expected_tables" ]; then
            echo "✓ All migration tables created successfully"
          else
            echo "✗ Migration verification failed!"
            echo "Expected: $expected_tables"
            echo "Got: $response"
            exit 1
          fi

      - name: Run E2E Tests
        run: pnpm run test:e2e
        timeout-minutes: 10
        env:
          CI: true

      - name: Cleanup Docker Compose
        if: always()
        run: docker compose down --volumes
